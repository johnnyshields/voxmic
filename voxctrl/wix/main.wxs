<?xml version="1.0" encoding="utf-8"?>
<!--
  WiX manifest for voxctrl MSI installer.
  Installs voxctrl.exe + config.json to %LOCALAPPDATA%\Voxctrl\
  and creates a scheduled task for auto-start at logon.

  Build (on Windows):
    cargo install cargo-wix
    cargo wix -\-nocapture    # produces target\wix\voxctrl-0.1.0-x86_64.msi
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product Id="*"
           Name="Voxctrl Dictation"
           Language="1033"
           Version="!(bind.FileVersion.VoxctrlExe)"
           Manufacturer="voxctrl"
           UpgradeCode="EB4044A7-9711-4616-B3E0-8B8381C73C7B">

    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perUser"
             InstallPrivileges="limited"
             Description="Voxctrl — cross-platform tray dictation app"
             Comments="Hold Ctrl+Win to record, transcribe via Voxtral" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of Voxctrl is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <!-- ================================================================== -->
    <!-- Install directory: %LOCALAPPDATA%\Voxctrl\                         -->
    <!-- ================================================================== -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="LocalAppDataFolder">
        <Directory Id="INSTALLFOLDER" Name="Voxctrl" />
      </Directory>
    </Directory>

    <!-- ================================================================== -->
    <!-- Components                                                          -->
    <!-- ================================================================== -->
    <DirectoryRef Id="INSTALLFOLDER">

      <!-- voxctrl.exe — KeyPath is a registry entry (required for per-user profile dirs) -->
      <Component Id="VoxctrlExeComponent"
                 Guid="90FEC48E-6554-443A-8294-CBFFE5424AC9">
        <File Id="VoxctrlExe"
              Name="voxctrl.exe"
              Source="target\x86_64-pc-windows-gnu\release\voxctrl.exe"
              KeyPath="no" />
        <RegistryValue Root="HKCU"
                       Key="Software\Voxctrl"
                       Name="InstallPath"
                       Type="string"
                       Value="[INSTALLFOLDER]"
                       KeyPath="yes" />
      </Component>

      <!-- config.json — default configuration -->
      <Component Id="ConfigJsonComponent"
                 Guid="0BE52EBB-2D69-4592-B38B-A76CA8F4D53A">
        <File Id="ConfigJson"
              Name="config.json"
              Source="config.json"
              KeyPath="no" />
        <RegistryValue Root="HKCU"
                       Key="Software\Voxctrl"
                       Name="ConfigDeployed"
                       Type="integer"
                       Value="1"
                       KeyPath="yes" />
      </Component>

    </DirectoryRef>

    <!-- ================================================================== -->
    <!-- Feature — single feature containing all components                  -->
    <!-- ================================================================== -->
    <Feature Id="MainFeature"
             Title="Voxctrl Dictation"
             Level="1"
             AllowAdvertise="no">
      <ComponentRef Id="VoxctrlExeComponent" />
      <ComponentRef Id="ConfigJsonComponent" />
    </Feature>

    <!-- ================================================================== -->
    <!-- Custom Actions — scheduled task for auto-start at logon             -->
    <!-- ================================================================== -->

    <!-- Property: full path to schtasks.exe -->
    <Property Id="SCHTASKS">
      <DirectorySearch Id="SchtasksSearch" Path="[SystemFolder]">
        <FileSearch Name="schtasks.exe" />
      </DirectorySearch>
    </Property>

    <!-- Create scheduled task on install -->
    <CustomAction Id="CreateScheduledTask"
                  Directory="INSTALLFOLDER"
                  ExeCommand='schtasks.exe /CREATE /F /TN "VoxctrlDictation" /SC ONLOGON /RL LIMITED /TR "&quot;[INSTALLFOLDER]voxctrl.exe&quot;"'
                  Execute="deferred"
                  Return="check"
                  Impersonate="yes" />

    <!-- Remove scheduled task on uninstall -->
    <CustomAction Id="RemoveScheduledTask"
                  Directory="INSTALLFOLDER"
                  ExeCommand='schtasks.exe /DELETE /F /TN "VoxctrlDictation"'
                  Execute="deferred"
                  Return="ignore"
                  Impersonate="yes" />

    <InstallExecuteSequence>
      <Custom Action="CreateScheduledTask" After="InstallFiles">
        NOT Installed OR REINSTALL
      </Custom>
      <Custom Action="RemoveScheduledTask" Before="RemoveFiles">
        REMOVE~="ALL"
      </Custom>
    </InstallExecuteSequence>

  </Product>
</Wix>
